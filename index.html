<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACNH Countdown (v3.0.0) — Timezone + Non-stalling Sync</title>
  <style>
    :root { color-scheme: light; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      background:
        radial-gradient(circle at 12% 15%, rgba(255,255,255,.75) 0 80px, transparent 85px),
        radial-gradient(circle at 28% 22%, rgba(255,255,255,.60) 0 64px, transparent 70px),
        radial-gradient(circle at 7% 30%, rgba(255,255,255,.45) 0 52px, transparent 60px),
        linear-gradient(180deg, #bfe9ff 0%, #fff2b8 45%, #c9f7c7 100%);
    }
    .wrap{ width:min(860px, 92vw); padding: 56px 0; }
    .card{
      margin: 0 auto;
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(8px);
      border-radius: 18px;
      box-shadow: 0 8px 30px rgba(0,0,0,.10);
      padding: 28px 26px;
      border: 1px solid rgba(0,0,0,.06);
      text-align:center;
    }
    h1{
      margin: 0 0 8px;
      font-size: clamp(20px, 2.4vw, 28px);
      font-weight: 750;
      letter-spacing: .2px;
    }
    .sub{ margin: 0 0 18px; opacity: .75; font-weight: 600; }
    .rows{
      margin: 14px auto 10px;
      display: grid;
      gap: 10px;
      width: min(520px, 100%);
      text-align:left;
    }
    .row{
      display:flex;
      justify-content:space-between;
      gap: 14px;
      font-size: 14px;
      line-height: 1.35;
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(0,0,0,.05);
    }
    .k{ opacity:.70; font-weight: 650; }
    .v{ font-variant-numeric: tabular-nums; font-weight: 650; }
    .remaining{
      margin: 16px 0 0;
      font-size: clamp(22px, 3.2vw, 34px);
      font-weight: 850;
      letter-spacing: .3px;
    }
    .pill{
      display:inline-block;
      margin-top: 14px;
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.70);
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .hint{
      margin-top: 18px;
      font-size: 12px;
      opacity: .7;
    }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Animal Crossing: New Horizons — Nintendo Switch 2 Edition (v3.0.0)</h1>
      <div class="sub">Timezone detection + non-stalling time sync</div>

      <div class="rows">
        <div class="row"><div class="k">Your time zone:</div><div class="v" id="tz">…</div></div>
        <div class="row"><div class="k">Target (Your time):</div><div class="v" id="target">…</div></div>
        <div class="row"><div class="k">Now (Your time):</div><div class="v" id="now">…</div></div>
      </div>

      <div class="remaining">Remaining: <span id="remaining">…</span></div>
      <div class="pill" id="status">Syncing time…</div>

      <div class="hint">
        Edit the target UTC time in the script by changing <code>TARGET_UTC_MS</code>.
      </div>
    </div>
  </div>

<script>
/* ==========
   Drop-in fix:
   - Detect user timezone (IANA)
   - Sync time using same-origin HTTP Date header (HEAD request)
   - Never stall: if sync fails, falls back to local clock and continues
   ========== */

// 1) Detect the user's IANA timezone (no permissions needed)
function getUserTimeZone() {
  return Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
}

// 2) Create a "now()" provider that is synced (or safely falls back)
async function createNowProvider({ timeoutMs = 2500 } = {}) {
  const localNowProvider = () => Date.now();
  const wrapWithPerf = (baseMs, basePerf) => () => baseMs + (performance.now() - basePerf);

  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const t0 = performance.now();

    // Same-origin HEAD request; on GitHub Pages this should return a Date header.
    const res = await fetch(location.href, {
      method: "HEAD",
      cache: "no-store",
      signal: controller.signal,
    });

    const t1 = performance.now();
    const dateHeader = res.headers.get("date") || res.headers.get("Date");
    if (!dateHeader) throw new Error("No Date header on response");

    const serverMs = Date.parse(dateHeader);
    if (!Number.isFinite(serverMs)) throw new Error("Unparseable Date header");

    // RTT compensation: assume server time corresponds roughly to midpoint of request.
    const rtt = t1 - t0;
    const estimatedNowAtT1 = serverMs + rtt / 2;

    return wrapWithPerf(estimatedNowAtT1, t1);
  } catch (err) {
    // Fallback: do NOT stall the UI
    const t = performance.now();
    return wrapWithPerf(localNowProvider(), t);
  } finally {
    clearTimeout(timer);
  }
}

// 3) Countdown wiring

// TODO: Set this to your actual target moment in UTC milliseconds.
// Example: Date.UTC(2026, 0, 31, 23, 59, 59)  // Months are 0-based (0 = Jan)
const TARGET_UTC_MS = Date.UTC(2026, 0, 31, 23, 59, 59);

const els = {
  tz: document.getElementById("tz"),
  target: document.getElementById("target"),
  now: document.getElementById("now"),
  remaining: document.getElementById("remaining"),
  status: document.getElementById("status"),
};

function fmtDate(ms, timeZone) {
  return new Intl.DateTimeFormat(undefined, {
    timeZone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
  }).format(new Date(ms));
}

function fmtRemaining(deltaMs) {
  const s = Math.max(0, Math.floor(deltaMs / 1000));
  const days = Math.floor(s / 86400);
  const hours = Math.floor((s % 86400) / 3600);
  const mins = Math.floor((s % 3600) / 60);
  const secs = s % 60;
  const pad = (n) => String(n).padStart(2, "0");
  return `${days}d ${pad(hours)}h ${pad(mins)}m ${pad(secs)}s`;
}

async function startCountdown() {
  const timeZone = getUserTimeZone();
  if (els.tz) els.tz.textContent = timeZone;

  if (els.status) els.status.textContent = "Syncing time…";
  const nowMs = await createNowProvider({ timeoutMs: 2500 });
  if (els.status) els.status.textContent = "Time synced ✓";

  if (els.target) els.target.textContent = fmtDate(TARGET_UTC_MS, timeZone);

  const tick = () => {
    const now = nowMs();
    if (els.now) els.now.textContent = fmtDate(now, timeZone);

    const remaining = TARGET_UTC_MS - now;
    if (els.remaining) els.remaining.textContent = fmtRemaining(remaining);

    if (remaining <= 0 && els.status) els.status.textContent = "Ready!";
  };

  tick();
  setInterval(tick, 250);
}

document.addEventListener("DOMContentLoaded", startCountdown);
</script>
</body>
</html>
